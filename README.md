# 增强版风险调整动量策略

这是一个基于Python实现的量化交易策略回测框架。该策略的核心是**风险调整动量 (Risk-Adjusted Momentum)**，旨在通过筛选在近期表现强劲，同时波动性较低的资产来构建投资组合，以期获得超越市场基准的稳定回报。

与传统动量策略仅关注收益率不同，本策略加入了风险维度（如波动率、下行频率等）对备选资产进行评分和排序，力求在追求高收益的同时控制回撤风险。

---

## 核心功能

- **多因子选股模型**:
  - **核心动量因子**: 可配置不同时间周期（如1个月、3个月、6个月）的动量，并为其分配权重。
  - **风险调整因子**: 综合考虑资产的波动率（可选择标准差或下行标准差）、最大回撤、下行波动频率等风险指标。
  - **成交量因子**: 结合成交量的变化，为动量信号提供额外的确认或警示。
  - **质量与市场环境调节**: 包含回报质量和市场环境调节模块，使策略能更好地适应不同市况。

- **灵活的投资组合构建**:
  - **多种加权方式**: 支持`等权重`、`基于因子值加权`和`波动率倒数加权`等多种方式构建投资组合。
  - **持仓数量可调**: 可自由设定投资组合中持有的股票数量。
  - **个股最大权重限制**: 可限制单只股票在投资组合中的最大权重，避免风险过于集中。

- **完善的风险管理机制**:
  - **个股止损**: 对投资组合中的每只股票设置独立的止损线，及时退出亏损头寸。
  - **下行频率过滤**: 过滤掉在近期频繁下跌的股票，即使其整体动量较高，也视其为不稳定信号。
  - **指数对冲 (可选)**: 可配置一定比例的纳斯达克100指数 (`^NDX`) 空头头寸，用于对冲市场系统性风险。

- **详细的回测与报告**:
  - **端到端回测引擎**: 包含数据加载、交易逻辑模拟（考虑交易成本）、持仓权重计算等。
  - **可视化绩效报告**: 自动生成包含净值曲线、回撤对比、月度收益热力图、最新持仓饼图的综合图表。
  - **关键绩效指标 (KPI)**: 自动计算并展示年化回报率、夏普比率、最大回撤、Alpha、Beta、信息比率等核心指标。
  - **Excel结果导出**: 将每日净值、调仓记录、绩效总览等详细数据导出到Excel文件，方便进一步分析。
  - **持仓建议生成**: 可在仅生成最新持仓建议模式下运行，用于实盘参考。

---

## 如何开始

### 1. 环境准备与依赖安装

本项目使用Python 3.x。首先，请确保您的系统已安装Python和pip。然后，通过以下命令安装所有必需的第三方库：

```bash
pip install -r requirements.txt
```

### 2. 策略配置

所有策略的核心参数都在 `config.py` 文件中进行统一管理。在运行前，您可以根据自己的研究和偏好修改这些参数。

关键配置项包括：
- `nasdaq_100_tickers`: 股票池，默认为纳斯达克100成分股。
- `start_date` / `backtest_start_date` / `end_date`: 回测的数据区间和执行区间。
- `weighting_method`: 投资组合的加权方法。
- `use_enhanced_factor`: 是否启用增强版的多因子模型。
- `apply_stop_loss`: 是否启用个股止损。
- `apply_ndx_short_hedge`: 是否启用指数做空对冲。
- `generate_recommendations_only`: 是否只生成最新建议而不运行完整回测。

详细参数说明请见 **配置详解** 部分。

### 3. 运行策略

完成配置后，直接运行主程序 `main.py` 即可启动回测。

```bash
python main.py
```

程序执行后，您将在控制台看到详细的日志输出，包括数据加载、回测进度和最终的绩效总结。生成的图表 (`.png`) 和Excel报告 (`.xlsx`) 会保存在项目根目录下。

---

## 文件结构

```
.
├── main.py                     # 主程序入口，协调各个模块
├── config.py                   # 策略配置文件，所有可调参数在此定义
├── data_loader.py              # 数据加载模块，负责从Yahoo Finance下载和预处理数据
├── factor_engine.py            # 因子计算引擎，负责计算所有选股因子
├── backtest_engine.py          # 回测引擎，负责执行交易逻辑和模拟投资组合
├── reporting.py                # 报告生成模块，负责计算绩效指标、绘制图表和导出Excel
├── requirements.txt            # 项目依赖库列表
└── README.md                   # 本说明文件
```

---

## 配置详解 (`config.py`)

#### 股票池与日期
- `nasdaq_100_tickers`: 定义用于选股的股票列表。
- `start_date`: 数据下载的起始日期，应早于回测起始日期以确保有足够数据计算初始因子。
- `backtest_start_date`: 策略回测的正式开始日期。
- `end_date`: 回测结束日期。

#### 投资组合构建
- `lookback_months`: 计算动量因子的主要回看周期（月）。
- `num_portfolio_stocks`: 投资组合中持有的股票数量。
- `max_single_stock_weight`: 单只股票允许的最大权重。
- `weighting_method`: 加权方法。
  - `'equal'`: 等权重。
  - `'factor_value'`: 根据最终因子分数值进行加权，分越高权重越大。
  - `'inverse_volatility'`: 根据波动率的倒数加权，波动率越低权重越大。

#### 核心因子与风控
- `use_enhanced_factor`: **(核心开关)** `True`表示使用复杂的多因子模型，`False`表示使用原始的简单动量因子。
- `enhanced_factor_config`: 当`use_enhanced_factor=True`时生效，定义了多周期动量、质量、市场环境等高级因子的具体配置。
- `apply_downside_frequency_filter`: 是否启用下行频率过滤器。
- `apply_volume_factor`: 是否启用成交量增强因子（在`use_enhanced_factor=False`时独立生效）。
- `apply_stop_loss`: 是否启用个股止损机制。
- `stop_loss_pct`: 止损幅度，例如 `0.10` 代表10%。
- `apply_ndx_short_hedge`: 是否启用纳斯达克100指数空头对冲。
- `ndx_short_ratio`: 对冲比例，例如 `0.20` 代表做空价值为总资产20%的指数。

#### 运行模式
- `generate_recommendations_only`: `True`则程序只计算并输出最新的持仓建议，不执行历史回测，速度快。`False`则执行完整的回测和分析。
- `transaction_cost_pct`: 单边交易成本费率。

---

## 输出结果

成功运行后，项目会生成以下产出：

1.  **控制台输出**: 实时展示程序执行步骤、当前的配置、最终的绩效指标摘要和最新一期的持仓建议。
2.  **综合绩效图表 (`strategy_performance_enhanced_v3.png`)**: 一张包含四部分的可视化图表，直观展示策略表现。
3.  **月度收益热力图 (`monthly_returns_heatmap_v3.png`)**: 单独保存的月度收益图，便于分析策略在不同年份和月份的表现。
4.  **Excel详细报告 (`Momentum_Backtest_Results_*.xlsx`)**:
    - `Portfolio_Value` sheet: 记录了每一天的投资组合净值。
    - `Rebalance_Weights` sheet: 记录了每个调仓日的详细持仓权重。
    - `Performance` sheet: 汇总了所有关键绩效指标。
5.  **持仓建议文件 (`Risk_Adjusted_Momentum_Recommendations_*.xlsx`)**:
    - `Risk_Adjusted_Recommendations` sheet: 记录了所有历史调仓日的原始权重数据。
    - `Formatted_Recommendations` sheet: 格式化后的持仓建议，可读性更强。 
